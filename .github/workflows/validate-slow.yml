name: Validate Slow Solutions

# Run weekly or manually - these are problems that take >2 minutes
on:
  schedule:
    - cron: '0 6 * * 0'  # Every Sunday at 6am UTC
  workflow_dispatch:
    inputs:
      problems:
        description: 'Comma-separated list of problem numbers to validate'
        required: false
        default: ''
      timeout:
        description: 'Timeout per problem in seconds'
        required: false
        default: '300'

jobs:
  validate-slow:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours max
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies (if needed)
        run: |
          pip install --upgrade pip
          # Install any dependencies from pyproject.toml if exists
          if [ -f pyproject.toml ]; then
            pip install -e . || true
          fi

      - name: Validate slow problems
        run: |
          if [ -n "${{ github.event.inputs.problems }}" ]; then
            python validate.py --problems "${{ github.event.inputs.problems }}" --timeout ${{ github.event.inputs.timeout || '300' }}
          else
            # Run on known slow problems (>60s timeout in normal run)
            # This list should be updated based on validation_results.json
            python validate.py --timeout 300
          fi

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-results-slow
          path: validation_results.json
          retention-days: 90

      - name: Create summary
        if: always()
        run: |
          echo "## Slow Problems Validation Summary" >> $GITHUB_STEP_SUMMARY
          if [ -f validation_results.json ]; then
            python3 -c "
          import json
          with open('validation_results.json') as f:
              data = json.load(f)
              results = data.get('results', data)
              passed = sum(1 for r in results.values() if r['status'] == 'passed')
              failed = sum(1 for r in results.values() if r['status'] == 'failed')
              errors = sum(1 for r in results.values() if r['status'] == 'error')
              timeouts = sum(1 for r in results.values() if r['status'] == 'timeout')
              total = len(results)
              print(f'Total problems: {total}')
              print(f'')
              print(f'| Status | Count |')
              print(f'|--------|-------|')
              print(f'| Passed | {passed} |')
              print(f'| Failed | {failed} |')
              print(f'| Errors | {errors} |')
              print(f'| Timeouts | {timeouts} |')
              print(f'')
              if failed > 0:
                  failed_list = sorted([int(k) for k, v in results.items() if v['status'] == 'failed'])
                  print(f'**Failed problems**: {failed_list}')
              if timeouts > 0:
                  timeout_list = sorted([int(k) for k, v in results.items() if v['status'] == 'timeout'])
                  print(f'**Timeout problems**: {timeout_list}')
          " >> $GITHUB_STEP_SUMMARY
          fi
