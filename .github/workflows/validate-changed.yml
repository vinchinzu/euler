name: Validate Changed Solutions

on:
  pull_request:
    branches: [master, main]
    paths:
      - 'python/**/*.py'

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      problems: ${{ steps.detect.outputs.problems }}
      has_changes: ${{ steps.detect.outputs.has_changes }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed problem files
        id: detect
        run: |
          # Get list of changed Python files
          CHANGED=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} -- 'python/*.py' | grep -E '^python/[0-9]+\.py$' || true)

          if [ -z "$CHANGED" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "problems=" >> $GITHUB_OUTPUT
            echo "No Python solution files changed"
          else
            # Extract problem numbers
            PROBLEMS=$(echo "$CHANGED" | sed 's|python/||g' | sed 's|\.py||g' | tr '\n' ',' | sed 's/,$//')
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "problems=$PROBLEMS" >> $GITHUB_OUTPUT
            echo "Changed problems: $PROBLEMS"
          fi

  validate-changed:
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Validate changed solutions
        run: |
          echo "Validating problems: ${{ needs.detect-changes.outputs.problems }}"
          python validate.py --problems "${{ needs.detect-changes.outputs.problems }}" --timeout 120 --ci

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-results-changed
          path: validation_results.json
