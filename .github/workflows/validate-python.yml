name: Validate Python Solutions

on:
  push:
    branches: [master, main]
    paths:
      - 'python/**/*.py'
      - 'solutions.txt'
      - 'validate.py'
      - '.github/workflows/validate-python.yml'
  pull_request:
    branches: [master, main]
    paths:
      - 'python/**/*.py'
      - 'solutions.txt'
      - 'validate.py'
  workflow_dispatch:
    inputs:
      problem_range:
        description: 'Problem range to validate (e.g., "1-50" or "all")'
        required: false
        default: '1-100'
      timeout:
        description: 'Timeout per problem in seconds'
        required: false
        default: '60'

jobs:
  # Quick validation for problems 1-100 (fast, should all pass)
  validate-easy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Validate problems 1-100
        run: python validate.py --max 100 --timeout 60 --ci

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-results-1-100
          path: validation_results.json

  # Medium difficulty problems (101-200)
  validate-medium:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Validate problems 101-200
        run: python validate.py --problems $(seq -s, 101 200) --timeout 120 --ci

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-results-101-200
          path: validation_results.json

  # Harder problems (201-300) - longer timeout
  validate-hard:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Validate problems 201-300
        run: python validate.py --problems $(seq -s, 201 300) --timeout 180 --ci

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-results-201-300
          path: validation_results.json

  # Summary job
  summary:
    needs: [validate-easy, validate-medium, validate-hard]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Summarize results
        run: |
          echo "## Validation Summary" >> $GITHUB_STEP_SUMMARY
          for dir in validation-results-*; do
            if [ -f "$dir/validation_results.json" ]; then
              echo "### $dir" >> $GITHUB_STEP_SUMMARY
              python3 -c "
          import json
          with open('$dir/validation_results.json') as f:
              data = json.load(f)
              results = data.get('results', data)
              passed = sum(1 for r in results.values() if r['status'] == 'passed')
              failed = sum(1 for r in results.values() if r['status'] == 'failed')
              errors = sum(1 for r in results.values() if r['status'] == 'error')
              timeouts = sum(1 for r in results.values() if r['status'] == 'timeout')
              print(f'- Passed: {passed}')
              print(f'- Failed: {failed}')
              print(f'- Errors: {errors}')
              print(f'- Timeouts: {timeouts}')
              if failed > 0:
                  failed_list = [k for k, v in results.items() if v['status'] == 'failed']
                  print(f'- Failed problems: {failed_list}')
          " >> $GITHUB_STEP_SUMMARY
            fi
          done
